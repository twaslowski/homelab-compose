---
services:
  tandoor:
    restart: always
    image: vabene1111/recipes
    volumes:
      - type: bind
        source: /opt/homelab/data/tandoor/media
        target: /opt/recipes/mediafiles
        bind:
          create_host_path: true
      - type: bind
        source: /opt/homelab/data/tandoor/static
        target: /opt/recipes/staticfiles
        bind:
          create_host_path: true
    env_file:
      - .env
    depends_on: [postgres]
    networks: [tandoor, homelab]
  postgres:
    image: postgres:18-alpine
    container_name: tandoor-postgres
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - type: bind
        source: /opt/homelab/data/tandoor/postgres
        target: /var/lib/postgresql/data
        bind:
          create_host_path: true
    networks: [tandoor]
    healthcheck:
      test: [CMD-SHELL, 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  nginx:
    image: nginx:mainline-alpine
    restart: always
    env_file: 
      - .env
    ports: [8080:80]
    volumes:
      - nginx_config:/etc/nginx/conf.d:ro
      - type: bind
        source: /opt/homelab/data/tandoor/media
        target: /opt/recipes/mediafiles
        bind:
          create_host_path: true
      - type: bind
        source: /opt/homelab/data/tandoor/static
        target: /opt/recipes/staticfiles
        bind:
          create_host_path: true
volumes:
  nginx_config:
networks:
  homelab:
    external: true
    name: ${HOMELAB_NETWORK:-homelab}
  tandoor:
    driver: bridge
    name: tandoor-internal
